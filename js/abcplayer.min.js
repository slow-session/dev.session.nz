var abcStopped=0;var abcCurrentTime=0;var intervalHandle;var currentABCslider=null;var bpmReset=0;var instrument;function abcPlayer.createABCplayer(textArea,tuneID,timbre){instrument=makeInstrument(timbre);var abcPlayer=`\n<form onsubmit="return false" oninput="level.value=flevel.valueAsNumber">\n    <div class="audioParentOuter" id="ABC${tuneID}">\n        \x3c!-- Col 1 --\x3e\n        <div class="playpauseButton">\n            <button id="playABC${tuneID}" class="playButton" onclick="playABC(${textArea}, playABC${tuneID}, '100')"></button>\n        </div>\n        \x3c!-- Nested row in second column --\x3e\n        <div class="audioChildOuter">\n            <div class="abcParentInner">\n                \x3c!-- Col 2 --\x3e\n                <div class="audioChildInner">\n                    <div id="audioSliderABC${tuneID}" class="abcAudioControl"></div>\n                </div>\n                \x3c!-- Col 3 --\x3e\n                <div class="audioChildInner">\n                    <span title="Adjust playback speed with slider">\n                        <div id="speedSliderABC${tuneID}" class="abcSpeedControl"></div>\n                        <p class="mp3SpeedLabel"><strong>Playback Speed</strong></p>\n                    </span>\n                </div>\n            </div>\n        </div>\n    </div>\n</form>`;return abcPlayer}function makeInstrument(timbre){var tempInstrument=new Instrument(timbre);return tempInstrument}function playABC(textArea,playButton,bpm){stopABCplayer();if(playButton.className=="playButton"){var tuneABC=preProcessABC(textArea.value);if(bpmReset){bpm=bpmReset}setTuneDuration(tuneABC,bpm);let ticks=calculateTicks(tuneABC,bpm);startABCplayer(tuneABC,ticks);playButton.className="";playButton.className="stopButton"}else{playButton.className="";playButton.className="playButton"}}function changeABCspeed(textArea,playButton,bpm){stopABCplayer();bpmReset=bpm;if(playButton.className=="stopButton"){var tuneABC=preProcessABC(textArea.value);setTuneDuration(tuneABC,bpm);let ticks=calculateTicks(tuneABC,bpm);startABCplayer(tuneABC,ticks)}}function setTuneDuration(tuneABC,bpm){var bars;bars=tuneABC.split("|").length;bars=Math.round(bars/8)*8;var meterStr=getABCheaderValue("M:",tuneABC);if(meterStr=="C"){meterStr="4/4"}if(meterStr=="C|"){meterStr="2/2"}var noteLenStr=getABCheaderValue("L:",tuneABC);if(!noteLenStr){noteLenStr="1/8"}let tuneDuration=bars*eval(meterStr)*16*eval(noteLenStr)*60/bpm;currentABCslider.noUiSlider.updateOptions({range:{min:0,max:tuneDuration}})}function calculateTicks(tuneABC,bpm){let noteLenStr=getABCheaderValue("L:",tuneABC);if(!noteLenStr){noteLenStr="1/8"}return bpm/(2*eval(noteLenStr))}function getABCheaderValue(key,tuneABC){var regex=new RegExp(key);var lines=tuneABC.split("\n");var ABCvalue="";var i;for(i=0;i<lines.length;i+=1){if(lines[i].match(regex)){ABCvalue=lines[i].replace(regex,"");ABCvalue=ABCvalue.replace(/^\s+|\s+$/g,"");break}}return ABCvalue}function startABCplayer(tuneABC,ticks){abcStopped=0;instrument.silence();instrument.play({tempo:ticks},tuneABC,(function(){loopABCplayer(tuneABC,ticks)}));abcCurrentTime=0;currentABCslider.noUiSlider.set(0);intervalHandle=setInterval(nudgeABCSlider,300)}function stopABCplayer(){clearInterval(intervalHandle);abcStopped=1;instrument.silence()}function loopABCplayer(tuneABC,ticks){instrument.silence();clearInterval(intervalHandle);if(abcStopped==0){startABCplayer(tuneABC,ticks)}}function nudgeABCSlider(){abcCurrentTime+=.3;currentABCslider.noUiSlider.set(abcCurrentTime)}function abcPlayer.createABCsliders(textArea,tuneID){let audioSlider=document.getElementById(`audioSliderABC${tuneID}`);let speedSlider=document.getElementById(`speedSliderABC${tuneID}`);let playButton=document.getElementById(`playABC${tuneID}`);let tuneABC=document.getElementById(textArea);currentABCslider=audioSlider;noUiSlider.create(audioSlider,{start:[0],tooltips:[wNumb({decimals:1})],range:{min:[0],max:[100]}});noUiSlider.create(speedSlider,{start:[100],tooltips:[wNumb({decimals:0,postfix:" %"})],range:{min:51,max:121}});speedSlider.noUiSlider.on("change",(function(value){changeABCspeed(tuneABC,playButton,value)}))}function preProcessABC(tuneABC){var lines=tuneABC.split("\n");var abcHeader=[""];var abcNotes=[""];var headerRegex=/^([A-Za-z]):\s*(.*)$/;var blankRegex=/^\s*(?:%.*)?$/;var tuneIndex=0;var endOfHeaderFound=false;var processedABC="";for(var j=0;j<lines.length;++j){if(headerRegex.exec(lines[j])){if(endOfHeaderFound){endOfHeaderFound=false;tuneIndex++;abcHeader[tuneIndex]="";abcNotes[tuneIndex]="";if(lines[j].startsWith("X:")){continue}}abcHeader[tuneIndex]+=lines[j]+"\n";if(lines[j].startsWith("K:")){endOfHeaderFound=true}}else if(blankRegex.test(lines[j])){continue}else{abcNotes[tuneIndex]+=lines[j]}}for(i=0;i<abcHeader.length;++i){processedABC+=abcHeader[i]+unRollABC(abcNotes[i])+"\n"}return processedABC}function unRollABC(abcNotes){var fEnding=/\|1/g,sEnding=/\|2/g,lRepeat=/\|:/g,rRepeat=/:\|/g,dblBar=/\|\|/g,firstBar=/\|/g;var fEnding2=/\[1/g,sEnding2=/\[2/g,dblBar2=/\|\]/g;var match,fBarPos=[],fEndPos=[],sEndPos=[],lRepPos=[],rRepPos=[],dblBarPos=[];var tokenString=[],tokenLocations=[],tokenCount=0,sortedTokens=[],sortedTokenLocations=[];var pos=0,i=0,k=0,l=0,m=0;var expandedABC="";while((match=firstBar.exec(abcNotes))!=null){fBarPos.push(match.index)}tokenString[tokenCount]="fb";if(fBarPos[0]>6){fBarPos[0]=0}tokenLocations[tokenCount++]=fBarPos[0];while(((match=fEnding.exec(abcNotes))||(match=fEnding2.exec(abcNotes)))!=null){fEndPos.push(match.index);tokenString[tokenCount]="fe";tokenLocations[tokenCount++]=match.index}while(((match=sEnding.exec(abcNotes))||(match=sEnding2.exec(abcNotes)))!=null){sEndPos.push(match.index);tokenString[tokenCount]="se";tokenLocations[tokenCount++]=match.index}while((match=rRepeat.exec(abcNotes))!=null){rRepPos.push(match.index);tokenString[tokenCount]="rr";tokenLocations[tokenCount++]=match.index}while((match=lRepeat.exec(abcNotes))!=null){lRepPos.push(match.index);tokenString[tokenCount]="lr";tokenLocations[tokenCount++]=match.index}while(((match=dblBar.exec(abcNotes))||(match=dblBar2.exec(abcNotes)))!=null){dblBarPos.push(match.index);tokenString[tokenCount]="db";tokenLocations[tokenCount++]=match.index}tokenString[tokenCount]="lb";tokenLocations[tokenCount++]=fBarPos[fBarPos.length-1];var indices=tokenLocations.map((function(elem,index){return index}));indices.sort((function(a,b){return tokenLocations[a]-tokenLocations[b]}));for(j=0;j<tokenLocations.length;j++){sortedTokens[j]=tokenString[indices[j]];sortedTokenLocations[j]=tokenLocations[indices[j]]}pos=0;for(i=0;i<sortedTokens.length;i++){if(expandedABC.length>1e3){break}if(sortedTokens[i]=="rr"||sortedTokens[i]=="se"){expandedABC+=abcNotes.substr(pos,sortedTokenLocations[i]-pos);for(k=i-1;k>=0;k--){if(sortedTokens[k]=="se"||sortedTokens[k]=="rr"||sortedTokens[k]=="fb"||sortedTokens[k]=="lr"){pos=sortedTokenLocations[k];for(j=k+1;j<sortedTokens.length;j++){if(sortedTokens[j]=="fe"||sortedTokens[j]=="rr"){expandedABC+=abcNotes.substr(pos,sortedTokenLocations[j]-pos);pos=sortedTokenLocations[j];i=j+1;if(sortedTokens[j]=="fe"){for(l=j;l<sortedTokens.length;l++){if(sortedTokens[l]=="se"){for(m=l;m<sortedTokens.length;m++){if(sortedTokens[m]=="db"){expandedABC+=abcNotes.substr(sortedTokenLocations[l],sortedTokenLocations[m]-sortedTokenLocations[l]);pos=sortedTokenLocations[m];i=m+1;break}}i=l+1;break}}}break}}break}}}}expandedABC+=abcNotes.substr(pos,sortedTokenLocations[sortedTokens.length-1]-pos);expandedABC=expandedABC.replace(/:\|/g,"|");expandedABC=expandedABC.replace(/\|:/g,"|");expandedABC=expandedABC.replace(/::/g,"|");expandedABC=expandedABC.replace(/\|+/g,"|");expandedABC=expandedABC.replace(/:$/,"|");expandedABC=expandedABC.replace(/:"$/,"|");return expandedABC}
