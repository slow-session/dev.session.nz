"use strict";const audioPlayer=function(){function myDebug(message){console.log(message)}var beginLoopTime=0;var endLoopTime=0;var previousPlayButton=null;var currentAudioSlider=null;var presetLoopSegments=[];var isIOS=testForIOS();function createAudioPlayer(){let audioPlayer=`\n\x3c!-- declare an Audio Player for this page--\x3e\n<audio id="OneAudioPlayer">\n    <source id="mp3Source" type="audio/mp3"></source> \n    Your browser does not support the audio format.\n</audio>`;return audioPlayer}function createMP3player(tuneID,mp3url){let mp3player=`\n<form onsubmit="return false" oninput="level.value = flevel.valueAsNumber">\n    <div id="audioPlayer-${tuneID}" class="audioParentOuter">\n        \x3c!-- Col 1 - play button --\x3e\n        <div class="playpauseButton">\n            <button id="playMP3-${tuneID}" class="playButton" onclick="audioPlayer.playAudio(${tuneID}, '${mp3url}')"></button>\n        </div>\n        \x3c!-- Nested row in second column --\x3e\n        <div class="audioChildOuter">\n            <div class="audioParentInner">\n                \x3c!-- Col 2 - audio slider --\x3e\n                <div class="audioChildInner">\n                    <div class="audio">\n                        <span title="Play the tune and then create a loop using the Start and End sliders">\n                            <div id="positionMP3-${tuneID}" class="mp3AudioControl"></div>\n                        </span>\n                    </div>\n                    <div class="mp3LoopControl">\n                        <span title="Play the tune and then create a loop using the Loop Start and Loop End buttons">\n                            <input type="button" class="loopButton" id="LoopStart" value=" Loop Start " onclick="audioPlayer.setFromSlider()" />\n                            <input type="button" class="loopButton" id="LoopEnd" value=" Loop End " onclick="audioPlayer.setToSlider()" />\n                            <input type="button" class="loopButton" id="Reset" value=" Reset " onclick="audioPlayer.resetFromToSliders()" />\n                        </span>\n                    </div>\n                </div>\n                \x3c!-- Col 3 - speed slider --\x3e\n                <div class="audioChildInner">\n                    <div id="speedControl-${tuneID}" class="mp3SpeedControl">\n                        <span title="Adjust playback speed with slider">\n                            <div id="speedSliderMP3-${tuneID}"></div>\n                            <p class="mp3SpeedLabel"><strong>Playback Speed</strong></p>\n                        </span>\n                    </div>\n                </div>\n            </div>\n        </div>\n    </div>\n</form>`;return mp3player}function createMP3Sliders(tuneID){let audioSlider=document.getElementById(`positionMP3-${tuneID}`);let speedSlider=document.getElementById(`speedSliderMP3-${tuneID}`);noUiSlider.create(audioSlider,{start:[0,0,100],connect:[false,true,true,false],behaviour:"drag",step:.25,range:{min:0,max:100}});noUiSlider.create(speedSlider,{start:[100],tooltips:[wNumb({decimals:0,postfix:" %"})],range:{min:51,max:121}});audioSlider.noUiSlider.on("change",(function(values,handle){if(handle===0){beginLoopTime=values[0];endLoopTime=assignendLoopTime(values[2]);saveUserLoop(values)}else if(handle===2){beginLoopTime=values[0];endLoopTime=assignendLoopTime(values[2]);saveUserLoop(values)}else if(handle===1){OneAudioPlayer.currentTime=values[1]}}));audioSlider.noUiSlider.on("start",(function(value){OneAudioPlayer.onplaying=function(){OneAudioPlayer.pause()}}));audioSlider.noUiSlider.on("end",(function(value){OneAudioPlayer.onplaying=function(){OneAudioPlayer.play()}}));speedSlider.noUiSlider.on("change",(function(value){myDebug("playbackRate: "+value/100);OneAudioPlayer.playbackRate=value/100}));speedSlider.noUiSlider.on("start",(function(value){OneAudioPlayer.onplaying=function(){OneAudioPlayer.pause()}}));speedSlider.noUiSlider.on("end",(function(value){OneAudioPlayer.onplaying=function(){OneAudioPlayer.play()}}))}function playAudio(tuneID,audioSource){let playButton=document.getElementById(`playMP3-${tuneID}`);let playPosition=document.getElementById(`positionMP3-${tuneID}`);let speedSlider=document.getElementById(`speedSliderMP3-${tuneID}`);if(playButton.className=="playButton"){if(!OneAudioPlayer.src.includes(audioSource)){if(OneAudioPlayer.src!=null){if(previousPlayButton!=null){previousPlayButton.className="playButton"}}previousPlayButton=playButton;LoadAudio(audioSource,playPosition);OneAudioPlayer.onloadedmetadata=function(){initialiseAudioSlider()}}if(!endLoopTime){endLoopTime=OneAudioPlayer.duration}OneAudioPlayer.addEventListener("timeupdate",positionUpdate);OneAudioPlayer.addEventListener("ended",restartLoop);OneAudioPlayer.playbackRate=speedSlider.noUiSlider.get()/100;let playPromise=OneAudioPlayer.play();if(playPromise){playPromise.catch((function(error){console.error(error)}))}playButton.className="";playButton.className="pauseButton"}else{OneAudioPlayer.pause();playButton.className="";playButton.className="playButton"}}function selectTune(storeID,tuneID){let item=storeID[tuneID];let showPlayer=document.getElementById("showPlayer");let tuneInfo=document.getElementById("tuneInfo");if(tuneInfo){tuneInfo.innerHTML=""}let loopPresetControls=document.getElementById("loopPresetControls");if(loopPresetControls){loopPresetControls.innerHTML=""}let loopForm=document.getElementById("loopForm");if(loopForm){loopForm.style.display="none"}presetLoopSegments=[];let dotsForm=document.getElementById("dotsForm");if(dotsForm){dotsForm.style.display="block"}let modal=document.getElementById("tuneModal");if(modal){modal.style.display="block"}let tuneTitle=document.getElementById("tuneTitle");if(tuneTitle){tuneTitle.innerHTML="<h2>"+item.title+"<span> - "+item.key+" "+item.rhythm+"</span></h2>"}if(item.mp3.includes("mp3")&&showPlayer){let tuneInfo=document.getElementById("tuneInfo");if(tuneInfo&&item.mp3_source){tuneInfo.innerHTML="Source: "+item.mp3_source}showPlayer.innerHTML=audioPlayer.createMP3player(tuneID,item.mp3);createMP3Sliders(tuneID);let playPosition=document.getElementById(`positionMP3-${tuneID}`);LoadAudio(item.mp3,playPosition);OneAudioPlayer.onloadedmetadata=function(){if(item.repeats&&item.parts){buildSegments(item);if(presetLoopSegments.length){document.getElementById("loopPresetControls").innerHTML=createLoopControlsContainer()}if(loopForm){loopForm.style.display="block"}}initialiseAudioSlider()}}else{if(showPlayer){let recordingMessage="<fieldset><strong>             A recording for this tune is not available.";if(modal){recordingMessage+='<br /><input class="filterButton" type="button" onclick="location.href=\''+item.url+'\';" value="Go to Tune Page" />';if(dotsForm){dotsForm.style.display="none"}}recordingMessage+="</strong></fieldset>";showPlayer.style.overflow="auto";showPlayer.innerHTML=recordingMessage}if(loopForm){loopForm.style.display="none"}}if(item.abc){let abcText=document.getElementById(`textAreaABC`);if(abcText){abcText.innerHTML=item.abc}let currentPaperState=document.getElementById("abcPaper").style.display;document.getElementById("abcPaper").style.display="block";let abc_editor=new window.ABCJS.Editor("textAreaABC",{paper_id:"abcPaper",warnings_id:"warnings",render_options:{responsive:"resize"},indicate_changed:"true"});document.getElementById("abcPaper").style.display=currentPaperState}else{document.getElementById("abcPaper").style.paddingBottom="0px";document.getElementById("abcPaper").style.overflow="auto";let urlSessionSearch="https://thesession.org/tunes/search?type="+item.rhythm+"&q="+item.title.replace(/\s+/g,"+");document.getElementById("abcPaper").innerHTML="<fieldset><strong>         <p>We don't have dots for this tune. If you find a version of the tune that's a good match, send         us a copy of the ABC and we'll get it added to the site. You might find it on The Session         at this link:</p>        <a href=\""+urlSessionSearch+'">'+urlSessionSearch+"</a>        </strong></fieldset>"}}function LoadAudio(audioSource,playPosition){OneAudioPlayer.src=audioSource;playPosition.noUiSlider.updateOptions({tooltips:[wNumb({decimals:1}),wNumb({decimals:1}),wNumb({decimals:1})]});currentAudioSlider=playPosition}function initialiseAudioSlider(){currentAudioSlider.noUiSlider.updateOptions({range:{min:0,max:OneAudioPlayer.duration}});resetFromToSliders()}function positionUpdate(){if(OneAudioPlayer.currentTime>=endLoopTime){OneAudioPlayer.currentTime=beginLoopTime}currentAudioSlider.noUiSlider.setHandle(1,OneAudioPlayer.currentTime)}function restartLoop(){OneAudioPlayer.currentTime=beginLoopTime;OneAudioPlayer.play()}function buildSegments(item){let parts=item.parts;let repeats=item.repeats;let mySegment;presetLoopSegments=[];if(parts.toString().includes("A")){let lastPart="";let part_names=parts.split("");let repeatCount=1;for(let i=0;i<part_names.length;i++){mySegment={name:0,start:0,end:0};if(lastPart==part_names[i]){repeatCount=2}else{repeatCount=1}mySegment.name=part_names[i]+" Repeat "+repeatCount;presetLoopSegments.push(mySegment);lastPart=part_names[i]}let start=0;let end=0;let each_part=OneAudioPlayer.duration/repeats/presetLoopSegments.length;for(let key in presetLoopSegments){start=each_part*key;end=start+each_part;presetLoopSegments[key].start=start.toFixed(1);presetLoopSegments[key].end=end.toFixed(1)}}mySegment={name:0,start:0,end:0};mySegment.name="User-1";mySegment.end=OneAudioPlayer.duration.toFixed(1);presetLoopSegments.push(mySegment)}function createLoopControlsContainer(){document.getElementById("loopForm").style.display="block";toggleLoops("Show Preset Loops");let loopControlsContainer=`\n<div class="container loop-container"><div class="row row-title">\n    <div class="small-4 columns"><strong>Select Preset Loops</strong></div>\n    <div class="small-4 columns" style="text-align: center;"><strong>Start</strong></div>\n    <div class="small-4 columns" style="text-align: center;"><strong>Finish</strong></div>\n</div>`;for(let segmentNumber=0;segmentNumber<presetLoopSegments.length;segmentNumber++){if(segmentNumber%2){loopControlsContainer+='<div class="row row-odd">'}else{loopControlsContainer+='<div class="row">'}loopControlsContainer+=`\n        \x3c!-- select loop --\x3e\n        <div class="small-4 columns"><input class="loopClass" type="checkbox" onclick="audioPlayer.applySegments()" id="check${segmentNumber}">${presetLoopSegments[segmentNumber].name}</div>\n        \x3c!-- adjust start of loop --\x3e\n        <div class="small-4 columns" style="text-align: center;">\n        <a href="javascript:void(0);" class = "downButton" type="button" id= "button${segmentNumber}dn" onclick="audioPlayer.adjustDown(${segmentNumber}, 0)"> \n        <span title=" - 1/5 second">&lt;&lt;</a>\n        <input class="loopClass" type="text" onchange="audioPlayer.applySegments()" id="check${segmentNumber}from" size="4" style= "height: 18px;" value=${presetLoopSegments[segmentNumber].start}> \n        <a href="javascript:void(0);" \n        class = "upButton" type="button" id= "button${segmentNumber}up" onclick="audioPlayer.adjustUp(${segmentNumber}, 0)"> \n        <span title=" + 1/5 second">&gt;&gt;</a> \n        </div>\n        \x3c!-- adjust end of loop --\x3e\n        <div class="small-4 columns" style="text-align: center;">\n        <a href="javascript:void(0);" class = "downButton" type="button" id= "button${segmentNumber}dn" onclick="audioPlayer.adjustDown(${segmentNumber}, 2)">\n        <span title=" - 1/5 second">&lt;&lt;</a> \n        <input class="loopClass" type="text" onchange="audioPlayer.applySegments()" id="check${segmentNumber}to" size="4" style= "height: 18px;" value=${presetLoopSegments[segmentNumber].end}> \n        <a href="javascript:void(0);" \n        class = "upButton" type="button" id= "button${segmentNumber}up" onclick="audioPlayer.adjustUp(${segmentNumber}, 2)"> \n        <span title=" + 1/5 second">&gt;&gt;</a> \n        </div>`;loopControlsContainer+="</div>"}loopControlsContainer+="</div>";return loopControlsContainer}function saveUserLoop(values){if(presetLoopSegments.length){let lastSegment=presetLoopSegments.length-1;if(document.getElementById("check"+lastSegment).checked){document.getElementById("check"+lastSegment+"from").value=Number(values[0]).toFixed(1);document.getElementById("check"+lastSegment+"to").value=Number(values[2]).toFixed(1)}}}function applySegments(){let fullbeginLoopTime=parseFloat(OneAudioPlayer.duration);let fullendLoopTime=0;let numCheckedBoxes=0;let tempbeginLoopTime=0;let tempendLoopTime=0;let checkBox,fromId,toId;for(let i=0;i<presetLoopSegments.length;i++){checkBox=document.getElementById("check"+i);fromId=document.getElementById("check"+i+"from");toId=document.getElementById("check"+i+"to");if(checkBox.checked==true){numCheckedBoxes++;tempbeginLoopTime=parseFloat(fromId.value);tempendLoopTime=parseFloat(toId.value);if(fullbeginLoopTime>tempbeginLoopTime){fullbeginLoopTime=tempbeginLoopTime}if(fullendLoopTime<tempendLoopTime){fullendLoopTime=tempendLoopTime}}}if(numCheckedBoxes>0){if(isIOS){OneAudioPlayer.oncanplaythrough=function(){OneAudioPlayer.currentTime=fullbeginLoopTime}}else{OneAudioPlayer.currentTime=fullbeginLoopTime}currentAudioSlider.noUiSlider.setHandle(0,0);currentAudioSlider.noUiSlider.setHandle(2,OneAudioPlayer.duration);currentAudioSlider.noUiSlider.setHandle(1,0);currentAudioSlider.noUiSlider.setHandle(1,fullbeginLoopTime);currentAudioSlider.noUiSlider.setHandle(0,fullbeginLoopTime);currentAudioSlider.noUiSlider.setHandle(2,fullendLoopTime);beginLoopTime=fullbeginLoopTime;endLoopTime=assignendLoopTime(fullendLoopTime);if(OneAudioPlayer.paused==false){let promise=OneAudioPlayer.play();if(promise){promise.catch((function(error){console.error(error)}))}}}else{resetFromToSliders()}}function adjustUp(row,inputBox){let elementName="check"+row;if(document.getElementById(elementName).checked==false){return}if(inputBox==0){elementName+="from"}else if(inputBox==2){elementName+="to"}let checkBox=document.getElementById(elementName);NumValue=Number(checkBox.value);if(NumValue<=OneAudioPlayer.duration-.2){checkBox.value=Number(NumValue+.2).toFixed(1);if(endLoopTime-checkBox.value>.21&inputBox==2){return}if(checkBox.value-beginLoopTime>.21&inputBox==0){return}if(inputBox==0&OneAudioPlayer.currentTime<checkBox.value){OneAudioPlayer.currentTime=checkBox.value}currentAudioSlider.noUiSlider.setHandle(inputBox,checkBox.value);if(inputBox==0){beginLoopTime=checkBox.value}else if(inputBox==2){endLoopTime=assignendLoopTime(checkBox.value)}}}function adjustDown(row,inputBox){let elementName="check"+row;if(document.getElementById(elementName).checked==false){return}if(inputBox==0){elementName+="from"}else if(inputBox==2){elementName+="to"}let checkBox=document.getElementById(elementName);NumValue=Number(checkBox.value);if(NumValue>=.2){checkBox.value=Number(NumValue-.2).toFixed(1);if(endLoopTime-checkBox.value>.21&inputBox==2){return}if(checkBox.value-beginLoopTime>.21&inputBox==0){return}if(inputBox==2&OneAudioPlayer.currentTime>checkBox.value){OneAudioPlayer.currentTime=checkBox.value}currentAudioSlider.noUiSlider.setHandle(inputBox,checkBox.value);if(inputBox==0){beginLoopTime=checkBox.value}else if(inputBox==2){endLoopTime=assignendLoopTime(checkBox.value)}}}function toggleLoops(button){switch(button.value){case"Show Preset Loops":button.value="Hide Preset Loops";document.getElementById("loopPresetControls").style.display="block";break;case"Hide Preset Loops":button.value="Show Preset Loops";document.getElementById("loopPresetControls").style.display="none";break}}function toggleTheDots(button){switch(button.value){case"Show the Dots":button.value="Hide the Dots";document.getElementById("abcPaper").style.display="block";break;case"Hide the Dots":button.value="Show the Dots";document.getElementById("abcPaper").style.display="none";break}}function toggleABC(button){switch(button.value){case"Show ABC Source":button.value="Hide ABC Source";document.getElementById("abcSource").style.display="block";break;case"Hide ABC Source":button.value="Show ABC Source";document.getElementById("abcSource").style.display="none";break}}function setFromSlider(){currentAudioSlider.noUiSlider.setHandle(0,OneAudioPlayer.currentTime);beginLoopTime=OneAudioPlayer.currentTime}function setToSlider(){currentAudioSlider.noUiSlider.setHandle(2,OneAudioPlayer.currentTime);endLoopTime=OneAudioPlayer.currentTime}function resetFromToSliders(){currentAudioSlider.noUiSlider.setHandle(0,0);beginLoopTime=0;currentAudioSlider.noUiSlider.setHandle(2,OneAudioPlayer.duration);endLoopTime=OneAudioPlayer.duration;for(let i=0;i<presetLoopSegments.length;i++){document.getElementById("check"+i).checked=false}}function assignendLoopTime(endLoopValue){if(endLoopValue>OneAudioPlayer.duration){endLoopValue=OneAudioPlayer.duration}return endLoopValue}function testForIOS(){let userAgent=navigator.userAgent||navigator.vendor||window.opera;if(userAgent.match(/iPad/i)||userAgent.match(/iPhone/i)||userAgent.match(/iPod/i)){return true}else{return false}}return{createAudioPlayer:createAudioPlayer,createMP3player:createMP3player,createMP3Sliders:createMP3Sliders,playAudio:playAudio,selectTune:selectTune,setFromSlider:setFromSlider,setToSlider:setToSlider,resetFromToSliders:resetFromToSliders,applySegments:applySegments,adjustUp:adjustUp,adjustDown:adjustDown,toggleABC:toggleABC,toggleTheDots:toggleTheDots,toggleLoops:toggleLoops}}();if(typeof module!=="undefined"&&module.exports){module.exports=audioPlayer}
