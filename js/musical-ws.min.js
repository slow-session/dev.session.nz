(function(f){if(typeof exports==="object"&&typeof module!=="undefined"){module.exports=f()}else if(typeof define==="function"&&define.amd){define([],f)}else{var g;if(typeof window!=="undefined"){g=window}else if(typeof global!=="undefined"){g=global}else if(typeof self!=="undefined"){g=self}else{g=this}g.musical=f()}})((function(){var define,module,exports;return function e(t,n,r){function s(o,u){if(!n[o]){if(!t[o]){var a=typeof require=="function"&&require;if(!u&&a)return a(o,!0);if(i)return i(o,!0);var f=new Error("Cannot find module '"+o+"'");throw f.code="MODULE_NOT_FOUND",f}var l=n[o]={exports:{}};t[o][0].call(l.exports,(function(e){var n=t[o][1][e];return s(n?n:e)}),l,l.exports,e,t,n,r)}return n[o].exports}var i=typeof require=="function"&&require;for(var o=0;o<r.length;o++)s(r[o]);return s}({1:[function(require,module,exports){var Instrument=require("./instrument");var parseABCFile=require("./parser-abc");window.Instrument=Instrument;window.parseABCFile=parseABCFile;module.exports={Instrument:Instrument,parseABCFile:parseABCFile}},{"./instrument":2,"./parser-abc":3}],2:[function(require,module,exports){var A440=440;var utils=require("./utils");var getAudioTop=utils.getAudioTop;var makeTimbre=utils.makeTimbre;var isAudioPresent=utils.isAudioPresent;var defaultTimbre=utils.defaultTimbre;var pitchToMidi=utils.pitchToMidi;var midiToFrequency=utils.midiToFrequency;var audioCurrentStartTime=utils.audioCurrentStartTime;var makeOscillator=utils.makeOscillator;var midiToPitch=utils.midiToPitch;var parseABCFile=require("./parser-abc");function Instrument(options){this._atop=getAudioTop();this._timbre=makeTimbre(options,this._atop);this._queue=[];this._minQueueTime=Infinity;this._maxScheduledTime=0;this._unsortedQueue=false;this._startSet=[];this._finishSet={};this._cleanupSet=[];this._callbackSet=[];this._handlers={};this._now=null;if(isAudioPresent()){this.silence()}}Instrument.timeOffset=.0625;Instrument.dequeueTime=.5;Instrument.bufferSecs=2;Instrument.toneLength=1;Instrument.cleanupDelay=.1;Instrument.prototype.setTimbre=function(t){this._timbre=makeTimbre(t,this._atop)};Instrument.prototype.getTimbre=function(t){return makeTimbre(this._timbre,this._atop)};Instrument.prototype.setVolume=function(v){if(!this._out){return}if(!isNaN(v)){this._out.gain.value=v}};Instrument.prototype.getVolume=function(v){if(!this._out){return 0}return this._out.gain.value};Instrument.prototype.silence=function(){var j,finished,callbacks,initvolume=1;this._queue.length=0;this._minQueueTime=Infinity;this._maxScheduledTime=0;this._startSet.length=0;finished=this._finishSet;this._finishSet={};callbacks=this._callbackSet;this._callbackSet=[];if(this._out){this._out.disconnect();initvolume=this._out.gain.value}this._atop=getAudioTop();this._out=this._atop.ac.createGain();this._out.gain.value=initvolume;this._out.connect(this._atop.out);for(j in finished){this._trigger("noteoff",finished[j])}for(j=0;j<callbacks.length;++j){callbacks[j].callback()}};Instrument.prototype.now=function(){if(this._now!=null){return this._now}this._startPollTimer(true);return this._now};Instrument.prototype.on=function(eventname,cb){if(!this._handlers.hasOwnProperty(eventname)){this._handlers[eventname]=[]}this._handlers[eventname].push(cb)};Instrument.prototype.off=function(eventname,cb){if(this._handlers.hasOwnProperty(eventname)){if(!cb){this._handlers[eventname]=[]}else{var j,hunt=this._handlers[eventname];for(j=0;j<hunt.length;++j){if(hunt[j]===cb){hunt.splice(j,1);j-=1}}}}};Instrument.prototype._trigger=function(eventname,record){var cb=this._handlers[eventname],j;if(!cb){return}if(cb.length==1){cb[0](record);return}cb=cb.slice();for(j=0;j<cb.length;++j){cb[j](record)}};Instrument.prototype._makeSound=function(record){var timbre=record.timbre||this._timbre,starttime=record.time+Instrument.timeOffset,releasetime=starttime+record.duration,attacktime=Math.min(releasetime,starttime+timbre.attack),decaytime=timbre.decay*Math.pow(A440/record.frequency,timbre.decayfollow),decaystarttime=attacktime,stoptime=releasetime+timbre.release,doubled=timbre.detune&&timbre.detune!=1,amp=timbre.gain*record.velocity*(doubled?.5:1),ac=this._atop.ac,g,f,o,o2,pwave,k,wf,bwf;if(record.duration>0&&record.velocity>0){g=ac.createGain();g.gain.setValueAtTime(0,starttime);g.gain.linearRampToValueAtTime(amp,attacktime);while(decaystarttime<attacktime+1/32&&decaystarttime+1/256<releasetime){decaystarttime+=1/256;g.gain.linearRampToValueAtTime(amp*(timbre.sustain+(1-timbre.sustain)*Math.exp((attacktime-decaystarttime)/decaytime)),decaystarttime)}g.gain.setTargetAtTime(amp*timbre.sustain,decaystarttime,decaytime);g.gain.setValueAtTime(amp*(timbre.sustain+(1-timbre.sustain)*Math.exp((attacktime-releasetime)/decaytime)),releasetime);g.gain.linearRampToValueAtTime(0,stoptime);g.connect(this._out);if(!timbre.cutoff&&!timbre.cutfollow||timbre.cutoff==Infinity){f=g}else{f=ac.createBiquadFilter();f.frequency.value=timbre.cutoff+record.frequency*timbre.cutfollow;f.Q.value=timbre.resonance;f.connect(g)}o=makeOscillator(this._atop,timbre.wave,record.frequency);o.connect(f);o.start(starttime);o.stop(stoptime);if(doubled){o2=makeOscillator(this._atop,timbre.wave,record.frequency*timbre.detune);o2.connect(f);o2.start(starttime);o2.stop(stoptime)}record.gainNode=g;record.oscillators=[o];if(doubled){record.oscillators.push(o2)}record.cleanuptime=stoptime}else{record.duration=0}this._startSet.push(record)};Instrument.prototype._truncateSound=function(record,truncatetime){if(truncatetime<record.time+record.duration){record.duration=Math.max(0,truncatetime-record.time);if(record.gainNode){var timbre=record.timbre||this._timbre,starttime=record.time+Instrument.timeOffset,releasetime=truncatetime+Instrument.timeOffset,attacktime=Math.min(releasetime,starttime+timbre.attack),decaytime=timbre.decay*Math.pow(A440/record.frequency,timbre.decayfollow),stoptime=releasetime+timbre.release,cleanuptime=stoptime+Instrument.cleanupDelay,doubled=timbre.detune&&timbre.detune!=1,amp=timbre.gain*record.velocity*(doubled?.5:1),j,g=record.gainNode;g.gain.cancelScheduledValues(releasetime);if(releasetime<=starttime){g.gain.setValueAtTime(0,releasetime)}else if(releasetime<=attacktime){g.gain.linearRampToValueAtTime(amp*(releasetime-starttime)/(attacktime-starttime))}else{g.gain.setValueAtTime(amp*(timbre.sustain+(1-timbre.sustain)*Math.exp((attacktime-releasetime)/decaytime)),releasetime)}g.gain.linearRampToValueAtTime(0,stoptime);if(record.oscillators){for(j=0;j<record.oscillators.length;++j){record.oscillators[j].stop(stoptime)}}record.cleanuptime=cleanuptime}}};Instrument.prototype._doPoll=function(){this._pollTimer=null;this._now=null;if(window.interrupted){this.silence();return}var instant=this._atop.ac.currentTime+1/2e3,callbacks=[],j,work,when,freq,record,conflict,save,cb;if(this._minQueueTime-instant<=Instrument.bufferSecs){if(this._unsortedQueue){this._queue.sort((function(a,b){if(a.time!=b.time){return a.time-b.time}if(a.duration!=b.duration){return a.duration-b.duration}return a.frequency-b.frequency}));this._unsortedQueue=false}for(j=0;j<this._queue.length;++j){if(this._queue[j].time-instant>Instrument.bufferSecs){break}}if(j>0){work=this._queue.splice(0,j);for(j=0;j<work.length;++j){this._makeSound(work[j])}this._minQueueTime=this._queue.length>0?this._queue[0].time:Infinity}}for(j=0;j<this._cleanupSet.length;++j){record=this._cleanupSet[j];if(record.cleanuptime<instant){if(record.gainNode){record.gainNode.disconnect();record.gainNode=null}this._cleanupSet.splice(j,1);j-=1}}for(freq in this._finishSet){record=this._finishSet[freq];when=record.time+record.duration;if(when<=instant){callbacks.push({order:[when,0],f:this._trigger,t:this,a:["noteoff",record]});if(record.cleanuptime!=Infinity){this._cleanupSet.push(record)}delete this._finishSet[freq]}}for(j=0;j<this._callbackSet.length;++j){cb=this._callbackSet[j];when=cb.time;if(when<=instant){callbacks.push({order:[when,1],f:cb.callback,t:null,a:[]});this._callbackSet.splice(j,1);j-=1}}for(j=0;j<this._startSet.length;++j){if(this._startSet[j].time<=instant){save=record=this._startSet[j];freq=record.frequency;conflict=null;if(this._finishSet.hasOwnProperty(freq)){conflict=this._finishSet[freq];if(conflict.time<record.time||conflict.time==record.time&&conflict.duration<record.duration){this._truncateSound(conflict,record.time);callbacks.push({order:[record.time,0],f:this._trigger,t:this,a:["noteoff",conflict]});delete this._finishSet[freq]}else{this._truncateSound(record,conflict.time);conflict=record}}this._startSet.splice(j,1);j-=1;if(record.duration>0&&record.velocity>0&&conflict!==record){this._finishSet[freq]=record;callbacks.push({order:[record.time,2],f:this._trigger,t:this,a:["noteon",record]})}}}this._startPollTimer();callbacks.sort((function(a,b){if(a.order[0]!=b.order[0]){return a.order[0]-b.order[0]}return a.order[1]-b.order[1]}));for(j=0;j<callbacks.length;++j){cb=callbacks[j];cb.f.apply(cb.t,cb.a)}};Instrument.prototype._startPollTimer=function(setnow){if(this._pollTimer&&this._now!=null){return}var self=this,poll=function(){self._doPoll()},earliest=Infinity,j,delay;if(this._pollTimer){clearTimeout(this._pollTimer);this._pollTimer=null}if(setnow){this._now=audioCurrentStartTime();this._pollTimer=setTimeout(poll,0);return}for(j=0;j<this._startSet.length;++j){earliest=Math.min(earliest,this._startSet[j].time)}for(j in this._finishSet){earliest=Math.min(earliest,this._finishSet[j].time+this._finishSet[j].duration)}for(j=0;j<this._callbackSet.length;++j){earliest=Math.min(earliest,this._callbackSet[j].time)}if(this._cleanupSet.length>0){earliest=Math.min(earliest,this._cleanupSet[0].cleanuptime+1)}earliest=Math.min(earliest,this._minQueueTime-Instrument.dequeueTime);delay=Math.max(.001,earliest-this._atop.ac.currentTime);if(isNaN(delay)||delay==Infinity){return}this._pollTimer=setTimeout(poll,Math.round(delay*1e3))};Instrument.prototype.tone=function(pitch,duration,velocity,delay,timbre,origin){if(!this._atop){return}if(typeof pitch=="object"){if(velocity==null)velocity=pitch.velocity;if(duration==null)duration=pitch.duration;if(delay==null)delay=pitch.delay;if(timbre==null)timbre=pitch.timbre;if(origin==null)origin=pitch.origin;pitch=pitch.pitch}var midi,frequency;if(!pitch){pitch="C"}if(isNaN(pitch)){midi=pitchToMidi(pitch);frequency=midiToFrequency(midi)}else{frequency=Number(pitch);if(frequency<0){midi=-frequency;frequency=midiToFrequency(midi)}else{midi=frequencyToMidi(frequency)}}if(!timbre){timbre=this._timbre}if(timbre!==this._timbre){var given=timbre,key;timbre={};for(key in defaultTimbre){if(key in given){timbre[key]=given[key]}else{timbre[key]=defaulTimbre[key]}}}var ac=this._atop.ac,now=this.now(),time=now+(delay||0),record={time:time,on:false,frequency:frequency,midi:midi,velocity:velocity==null?1:velocity,duration:duration==null?Instrument.toneLength:duration,timbre:timbre,instrument:this,gainNode:null,oscillators:null,cleanuptime:Infinity,origin:origin};if(time<now+Instrument.bufferSecs){this._makeSound(record)}else{if(!this._unsortedQueue&&this._queue.length&&time<this._queue[this._queue.length-1].time){this._unsortedQueue=true}this._queue.push(record);this._minQueueTime=Math.min(this._minQueueTime,record.time)}};Instrument.prototype.schedule=function(delay,callback){this._callbackSet.push({time:this.now()+delay,callback:callback})};Instrument.prototype.play=function(abcstring){var args=Array.prototype.slice.call(arguments),done=null,opts={},subfile,abcfile,argindex,tempo,timbre,k,delay,maxdelay=0,attenuate,voicename,stems,ni,vn,j,stem,note,beatsecs,secs,v,files=[];if(args.length&&"function"==typeof args[args.length-1]){done=args.pop()}if(!this._atop){if(done){done()}return}argindex=0;if("object"==typeof args[0]){for(k in args[0])if(args[0].hasOwnProperty(k)){opts[k]=args[0][k]}argindex=1;if(opts.song){args.push(opts.song)}}for(;argindex<args.length;++argindex){subfile=args[argindex].split(/\n(?=X:)/);for(k=0;k<subfile.length;++k){abcfile=parseABCFile(subfile[k]);if(!abcfile)continue;if(!opts.tempo&&abcfile.tempo){opts.tempo=abcfile.tempo;if(abcfile.unitbeat){opts.tempo*=abcfile.unitbeat/(abcfile.unitnote||1)}}if(!abcfile.voice)continue;files.push(abcfile)}}if(!opts.tempo){opts.tempo=120}if(opts.volume==null){opts.volume=1}beatsecs=60/opts.tempo;for(k=0;k<files.length;++k){abcfile=files[k];for(vn in abcfile.voice){timbre=makeTimbre(opts.timbre||abcfile.voice[vn].timbre||abcfile.timbre||this._timbre,this._atop);stems=abcfile.voice[vn].stems;if(!stems)continue;delay=0;for(ni=0;ni<stems.length;++ni){stem=stems[ni];attenuate=1/Math.sqrt(stem.notes.length);for(j=0;j<stem.notes.length;++j){note=stem.notes[j];if(note.holdover){continue}secs=(note.time||stem.time)*beatsecs;if(stem.staccato){secs=Math.min(Math.min(secs,beatsecs/16),timbre.attack+timbre.decay)}else if(!note.slurred&&secs>=1/8){secs-=1/32}v=(note.velocity||1)*attenuate*opts.volume;this.tone(note.pitch,secs,v,delay,timbre,note)}delay+=stem.time*beatsecs}maxdelay=Math.max(delay,maxdelay)}}this._maxScheduledTime=Math.max(this._maxScheduledTime,this.now()+maxdelay);if(done){this.schedule(maxdelay,done)}};Instrument.pitchToMidi=function(n){if(typeof n=="string"){return pitchToMidi(n)}return n};Instrument.midiToPitch=function(n){if(typeof n=="number"){return midiToPitch(n)}return n};module.exports=Instrument},{"./parser-abc":3,"./utils":4}],3:[function(require,module,exports){var utils=require("./utils");var pitchToFrequency=utils.pitchToFrequency;var ABCheader=/^([A-Za-z]):\s*(.*)$/;var ABCtoken=/(?:\[[A-Za-z]:[^\]]*\])|\s+|%[^\n]*|![^\s!:|\[\]]*!|\+[^+|!]*\+|[_<>@^]?"[^"]*"|\[|\]|>+|<+|(?:(?:\^+|_+|=|)[A-Ga-g](?:,+|'+|))|\(\d+(?::\d+){0,2}|\d*\/\d+|\d+\/?|\/+|[xzXZ]|\[?\|\]?|:?\|:?|::|./g;module.exports=function parseABCFile(str){var lines=str.split("\n"),result={},context=result,timbre,j,k,header,stems,key={},accent={slurred:0},voiceid,out;for(j=0;j<lines.length;++j){header=ABCheader.exec(lines[j]);if(header){handleInformation(header[1],header[2].trim())}else if(/^\s*(?:%.*)?$/.test(lines[j])){continue}else{parseABCNotes(lines[j])}}var infer=["unitnote","unitbeat","tempo"];if(result.voice){out=[];for(j in result.voice){if(result.voice[j].stems&&result.voice[j].stems.length){processTies(result.voice[j].stems);for(k=0;k<infer.length;++k){if(!(infer[k]in result)&&infer[k]in result.voice[j]){result[infer[k]]=result.voice[j][infer[k]]}}delete result.voice[j].accent}else{out.push(j)}}for(j=0;j<out.length;++j){delete result.voice[out[j]]}}return result;function handleInformation(field,value){switch(field){case"V":if(context!==result){startVoiceContext(value.split(" ")[0])}break;case"M":parseMeter(value,context);break;case"L":parseUnitNote(value,context);break;case"Q":parseTempo(value,context);break}if(context.hasOwnProperty(field)){context[field]+="\n"+value}else{context[field]=value}if(field=="K"){key=keysig(value);if(context===result){startVoiceContext(firstVoiceName())}}}function startVoiceContext(id){id=id||"";if(!id&&context!==result){return}if(!result.voice){result.voice={}}if(result.voice.hasOwnProperty(id)){context=result.voice[id];accent=context.accent}else{context={id:id,accent:{slurred:0}};result.voice[id]=context;accent=context.accent}}function firstVoiceName(){if(result.V){return result.V.split(/\s+/)[0]}else{return""}}function parseABCNotes(str){var tokens=str.match(ABCtoken),parsed=null,index=0,dotted=0,beatlet=null,t;if(!tokens){return null}while(index<tokens.length){if(/^[\s%]/.test(tokens[index])){index++;continue}if(/^\[[A-Za-z]:[^\]]*\]$/.test(tokens[index])){handleInformation(tokens[index].substring(1,2),tokens[index].substring(3,tokens[index].length-1).trim());index++;continue}if(/</.test(tokens[index])){dotted=-tokens[index++].length;continue}if(/>/.test(tokens[index])){dotted=tokens[index++].length;continue}if(/^\(\d+(?::\d+)*/.test(tokens[index])){beatlet=parseBeatlet(tokens[index++]);continue}if(/^[!+].*[!+]$/.test(tokens[index])){parseDecoration(tokens[index++],accent);continue}if(tokens[index]=="{"){while(index<tokens.length){if(tokens[index++]=="}")break}continue}if(/^.?".*"$/.test(tokens[index])){index++;continue}if(/^[()]$/.test(tokens[index])){if(tokens[index++]=="("){accent.slurred+=1}else{accent.slurred-=1;if(accent.slurred<=0){accent.slurred=0;if(context.stems&&context.stems.length>=1){slurStem(context.stems[context.stems.length-1],false)}}}continue}if(/\|/.test(tokens[index])){for(t in accent){if(t.length==1){delete accent[t]}}index++;continue}parsed=parseStem(tokens,index,key,accent);if(parsed===null){index++;continue}if(beatlet){scaleStem(parsed.stem,beatlet.time);beatlet.count-=1;if(!beatlet.count){beatlet=null}}if(dotted&&context.stems&&context.stems.length){if(dotted>0){t=(1-Math.pow(.5,dotted))*parsed.stem.time}else{t=(Math.pow(.5,-dotted)-1)*context.stems[context.stems.length-1].time}syncopateStem(context.stems[context.stems.length-1],t);syncopateStem(parsed.stem,-t)}dotted=0;if(accent.slurred){slurStem(parsed.stem,true)}if(context===result){startVoiceContext(firstVoiceName())}if(!("stems"in context)){context.stems=[]}context.stems.push(parsed.stem);index=parsed.index}}function parseMeter(mline,beatinfo){var d=/^C/.test(mline)?4/4:durationToTime(mline);if(!d){return}if(!beatinfo.unitnote){if(d<.75){beatinfo.unitnote=1/16}else{beatinfo.unitnote=1/8}}}function parseUnitNote(lline,beatinfo){var d=durationToTime(lline);if(!d){return}beatinfo.unitnote=d}function parseTempo(qline,beatinfo){var parts=qline.split(/\s+|=/),j,unit=null,tempo=null;for(j=0;j<parts.length;++j){if(parts[j].indexOf("/")>=0||/^[1-4]$/.test(parts[j])){unit=unit||durationToTime(parts[j])}else{tempo=tempo||Number(parts[j])}}if(unit){beatinfo.unitbeat=unit}if(tempo){beatinfo.tempo=tempo}}function processTies(stems){var tied={},nextTied,j,k,note,firstNote;for(j=0;j<stems.length;++j){nextTied={};for(k=0;k<stems[j].notes.length;++k){firstNote=note=stems[j].notes[k];if(tied.hasOwnProperty(note.pitch)){firstNote=tied[note.pitch];firstNote.time+=note.time;note.holdover=true}if(note.tie){nextTied[note.pitch]=firstNote}}tied=nextTied}}function accidentals(n){var sharps="FCGDAEB",result={},j;if(!n){return result}if(n>0){for(j=0;j<n&&j<7;++j){result[sharps.charAt(j)]="^"}}else{for(j=0;j>n&&j>-7;--j){result[sharps.charAt(6+j)]="_"}}return result}function keysig(keyname){if(!keyname){return{}}var kkey,sigcodes={"c#":7,"f#":6,b:5,e:4,a:3,d:2,g:1,c:0,f:-1,bb:-2,eb:-3,ab:-4,db:-5,gb:-6,cb:-7,"a#m":7,"d#m":6,"g#m":5,"c#m":4,"f#m":3,bm:2,em:1,am:0,dm:-1,gm:-2,cm:-3,fm:-4,bbm:-5,ebm:-6,abm:-7,"g#mix":7,"c#mix":6,"f#mix":5,bmix:4,emix:3,amix:2,dmix:1,gmix:0,cmix:-1,fmix:-2,bbmix:-3,ebmix:-4,abmix:-5,dbmix:-6,gbmix:-7,"d#dor":7,"g#dor":6,"c#dor":5,"f#dor":4,bdor:3,edor:2,ador:1,ddor:0,gdor:-1,cdor:-2,fdor:-3,bbdor:-4,ebdor:-5,abdor:-6,dbdor:-7,"e#phr":7,"a#phr":6,"d#phr":5,"g#phr":4,"c#phr":3,"f#phr":2,bphr:1,ephr:0,aphr:-1,dphr:-2,gphr:-3,cphr:-4,fphr:-5,bbphr:-6,ebphr:-7,"f#lyd":7,blyd:6,elyd:5,alyd:4,dlyd:3,glyd:2,clyd:1,flyd:0,bblyd:-1,eblyd:-2,ablyd:-3,dblyd:-4,gblyd:-5,cblyd:-6,fblyd:-7,"b#loc":7,"e#loc":6,"a#loc":5,"d#loc":4,"g#loc":3,"c#loc":2,"f#loc":1,bloc:0,eloc:-1,aloc:-2,dloc:-3,gloc:-4,cloc:-5,floc:-6,bbloc:-7};var k=keyname.replace(/\s+/g,"").toLowerCase().substr(0,5);var scale=k.match(/maj|min|mix|dor|phr|lyd|loc|m/);if(scale){if(scale=="maj"){kkey=k.substr(0,scale.index)}else if(scale=="min"){kkey=k.substr(0,scale.index+1)}else{kkey=k.substr(0,scale.index+scale[0].length)}}else{kkey=/^[a-g][#b]?/.exec(k)||""}var result=accidentals(sigcodes[kkey]);var extras=keyname.substr(kkey.length).match(/(_+|=|\^+)[a-g]/gi);if(extras){for(var j=0;j<extras.length;++j){var note=extras[j].charAt(extras[j].length-1).toUpperCase();if(extras[j].charAt(0)=="="){delete result[note]}else{result[note]=extras[j].substr(0,extras[j].length-1)}}}return result}function syncopateStem(stem,t){var j,note,stemtime=stem.time,newtime=stemtime+t;stem.time=newtime;for(j=0;j<stem.notes.length;++j){note=stem.notes[j];if(note.time==stemtime){note.time=newtime}}}function slurStem(stem,addSlur){var j,note;for(j=0;j<stem.notes.length;++j){note=stem.notes[j];if(addSlur){note.slurred=true}else if(note.slurred){delete note.slurred}}}function scaleStem(stem,s){var j;stem.time*=s;for(j=0;j<stem.notes.length;++j){stem.notes[j].time*=s}}function parseBeatlet(token){var m=/^\((\d+)(?::(\d+)(?::(\d+))?)?$/.exec(token);if(!m){return null}var count=Number(m[1]),beats=Number(m[2])||2,duration=Number(m[3])||count;return{time:beats/count,count:duration}}function parseDecoration(token,accent){if(token.length<2){return}token=token.substring(1,token.length-1);switch(token){case"pppp":case"ppp":accent.dynamics=.2;break;case"pp":accent.dynamics=.4;break;case"p":accent.dynamics=.6;break;case"mp":accent.dynamics=.8;break;case"mf":accent.dynamics=1;break;case"f":accent.dynamics=1.2;break;case"ff":accent.dynamics=1.4;break;case"fff":case"ffff":accent.dynamics=1.5;break}}function parseStem(tokens,index,key,accent){var notes=[],duration="",staccato=false,noteDuration,noteTime,velocity,lastNote=null,minStemTime=Infinity,j;if(index<tokens.length&&"."==tokens[index]){staccato=true;index++}if(index<tokens.length&&tokens[index]=="["){index++;while(index<tokens.length){if(/^[\s%]/.test(tokens[index])){index++;continue}if(/[A-Ga-g]/.test(tokens[index])){lastNote={pitch:applyAccent(tokens[index++],key,accent),tie:false};lastNote.frequency=pitchToFrequency(lastNote.pitch);notes.push(lastNote)}else if(/[xzXZ]/.test(tokens[index])){lastNote=null;index++}else if("."==tokens[index]){staccato=true;index++;continue}else{break}if(index<tokens.length&&/^(?![\s%!]).*[\d\/]/.test(tokens[index])){noteDuration=tokens[index++];noteTime=durationToTime(noteDuration)}else{noteDuration="";noteTime=1}if(lastNote){lastNote.duration=noteDuration;lastNote.time=noteTime}if(noteTime&&noteTime<minStemTime){duration=noteDuration;minStemTime=noteTime}if(index<tokens.length&&"-"==tokens[index]){if(lastNote){notes[notes.length-1].tie=true}index++}}if(tokens[index]!="]"){return null}index++}else if(index<tokens.length&&/[A-Ga-g]/.test(tokens[index])){lastNote={pitch:applyAccent(tokens[index++],key,accent),tie:false,duration:"",time:1};lastNote.frequency=pitchToFrequency(lastNote.pitch);notes.push(lastNote)}else if(index<tokens.length&&/^[xzXZ]$/.test(tokens[index])){index++}else{return null}if(index<tokens.length&&/^(?![\s%!]).*[\d\/]/.test(tokens[index])){duration=tokens[index++];noteTime=durationToTime(duration);for(j=0;j<notes.length;++j){notes[j].duration=duration;notes[j].time=noteTime}}if(index<tokens.length&&"-"==tokens[index]){index++;for(j=0;j<notes.length;++j){notes[j].tie=true}}if(accent.dynamics){velocity=accent.dynamics;for(j=0;j<notes.length;++j){notes[j].velocity=velocity}}return{index:index,stem:{notes:notes,duration:duration,staccato:staccato,time:durationToTime(duration)}}}function stripNatural(pitch){if(pitch.length>0&&pitch.charAt(0)=="="){return pitch.substr(1)}return pitch}function applyAccent(pitch,key,accent){var m=/^(\^+|_+|=|)([A-Ga-g])(.*)$/.exec(pitch),letter;if(!m){return pitch}letter=m[2].toUpperCase();if(m[1].length>0){accent[letter]=m[1];return stripNatural(pitch)}if(accent.hasOwnProperty(letter)){return stripNatural(accent[letter]+m[2]+m[3])}if(key.hasOwnProperty(letter)){return stripNatural(key[letter]+m[2]+m[3])}return stripNatural(pitch)}function durationToTime(duration){var m=/^(\d*)(?:\/(\d*))?$|^(\/+)$/.exec(duration),n,d,i=0,ilen;if(!m)return;if(m[3])return Math.pow(.5,m[3].length);d=m[2]?parseFloat(m[2]):/\//.test(duration)?2:1;ilen=0;n=m[1]?parseFloat(m[1]):1;if(m[2]){while(ilen+1<m[1].length&&n>d){ilen+=1;i=parseFloat(m[1].substring(0,ilen));n=parseFloat(m[1].substring(ilen))}}return i+n/d}}},{"./utils":4}],4:[function(require,module,exports){(function(global){var makeWavetable=require("./wavetable-builder");module.exports.isAudioPresent=isAudioPresent=function(){return!!(global.AudioContext||global.webkitAudioContext)};module.exports.getAudioTop=getAudioTop=function(){if(getAudioTop.audioTop){return getAudioTop.audioTop}if(!isAudioPresent()){return null}var ac=new(global.AudioContext||global.webkitAudioContext);getAudioTop.audioTop={ac:ac,wavetable:makeWavetable(ac),out:null,currentStart:null};resetAudio();return getAudioTop.audioTop};function resetAudio(){if(getAudioTop.audioTop){var atop=getAudioTop.audioTop;if(atop.out){atop.out.disconnect();atop.out=null;atop.currentStart=null}var dcn=atop.ac.createDynamicsCompressor();dcn.ratio=16;dcn.attack=5e-4;dcn.connect(atop.ac.destination);atop.out=dcn}}module.exports.audioCurrentStartTime=audioCurrentStartTime=function(){var atop=getAudioTop();if(atop.currentStart!=null){return atop.currentStart}atop.currentStart=Math.max(.25,atop.ac.currentTime);setTimeout((function(){atop.currentStart=null}),0);return atop.currentStart};var A440=440;module.exports.midiToFrequency=midiToFrequency=function(midi){return A440*Math.pow(2,(midi-69)/12)};var noteNum={C:0,D:2,E:4,F:5,G:7,A:9,B:11,c:12,d:14,e:16,f:17,g:19,a:21,b:23};var accSym={"^":1,"":0,"=":0,_:-1};var noteName=["C","^C","D","_E","E","F","^F","G","_A","A","_B","B","c","^c","d","_e","e","f","^f","g","_a","a","_b","b"];function frequencyToMidi(freq){return Math.round(69+Math.log(freq/A440)*12/Math.LN2)}module.exports.pitchToMidi=pitchToMidi=function(pitch){var m=/^(\^+|_+|=|)([A-Ga-g])([,']*)$/.exec(pitch);if(!m){return null}var octave=m[3].replace(/,/g,"").length-m[3].replace(/'/g,"").length;var semitone=noteNum[m[2]]+accSym[m[1].charAt(0)]*m[1].length+12*octave;return semitone+60};module.exports.midiToPitch=function(midi){var index=(midi-72)%12;if(midi>60||index!=0){index+=12}var octaves=Math.round((midi-index-60)/12),result=noteName[index];while(octaves!=0){result+=octaves>0?"'":",";octaves+=octaves>0?-1:1}return result};module.exports.pitchToFrequency=pitchToFrequency=function(pitch){return midiToFrequency(pitchToMidi(pitch))};module.exports.defaultTimbre=defaultTimbre={wave:"square",gain:.1,attack:.002,decay:.4,decayfollow:0,sustain:0,release:.1,cutoff:0,cutfollow:0,resonance:0,detune:0};module.exports.makeTimbre=function(options,atop){if(!options){options={}}if(typeof options=="string"){options={wave:options}}var result={},key,wt=atop&&atop.wavetable&&atop.wavetable[options.wave];for(key in defaultTimbre){if(options.hasOwnProperty(key)){result[key]=options[key]}else if(wt&&wt.defs&&wt.defs.hasOwnProperty(key)){result[key]=wt.defs[key]}else{result[key]=defaultTimbre[key]}}return result};var whiteNoiseBuf=null;function getWhiteNoiseBuf(){if(whiteNoiseBuf==null){var ac=getAudioTop().ac,bufferSize=2*ac.sampleRate,whiteNoiseBuf=ac.createBuffer(1,bufferSize,ac.sampleRate),output=whiteNoiseBuf.getChannelData(0);for(var i=0;i<bufferSize;i++){output[i]=Math.random()*2-1}}return whiteNoiseBuf}module.exports.makeOscillator=makeOscillator=function(atop,wavename,freq){if(wavename=="noise"){var whiteNoise=atop.ac.createBufferSource();whiteNoise.buffer=getWhiteNoiseBuf();whiteNoise.loop=true;return whiteNoise}var wavetable=atop.wavetable,o=atop.ac.createOscillator(),k,pwave,bwf,wf;try{if(wavetable.hasOwnProperty(wavename)){pwave=wavetable[wavename].wave;if(wavetable[wavename].freq){bwf=0;for(k in wavetable[wavename].freq){wf=Number(k);if(freq>wf&&wf>bwf){bwf=wf;pwave=wavetable[wavename].freq[bwf]}}}if(!o.setPeriodicWave&&o.setWaveTable){o.setWaveTable(pwave)}else{o.setPeriodicWave(pwave)}}else{o.type=wavename}}catch(e){if(window.console){window.console.log(e)}o.type="square"}o.frequency.value=freq;return o}}).call(this,typeof global!=="undefined"?global:typeof self!=="undefined"?self:typeof window!=="undefined"?window:{})},{"./wavetable-builder":5}],5:[function(require,module,exports){module.exports=function(ac){return function(wavedata){function makePeriodicWave(data){var n=data.real.length,real=new Float32Array(n),imag=new Float32Array(n),j;for(j=0;j<n;++j){real[j]=data.real[j];imag[j]=data.imag[j]}try{return ac.createPeriodicWave(real,imag)}catch(e){}try{return ac.createWaveTable(real,imag)}catch(e){}return null}function makeMultiple(data,mult,amt){var result={real:[],imag:[]},j,n=data.real.length,m;for(j=0;j<n;++j){m=Math.log(mult[Math.min(j,mult.length-1)]);result.real.push(data.real[j]*Math.exp(amt*m));result.imag.push(data.imag[j]*Math.exp(amt*m))}return result}var result={},k,d,n,j,ff,record,wave,pw;for(k in wavedata){d=wavedata[k];wave=makePeriodicWave(d);if(!wave){continue}record={wave:wave};if(d.mult){ff=wavedata[k].freq;record.freq={};for(j=0;j<ff.length;++j){wave=makePeriodicWave(makeMultiple(d,d.mult,(j+1)/ff.length));if(wave){record.freq[ff[j]]=wave}}}if(d.defs){record.defs=d.defs}result[k]=record}return result}({piano:{real:[0,-0,-.179748,.252497,-.212162,.069443,-.067304,.006291,-.063344,.007604,-.069661,.004429,-.01903,601e-6,-.001895,841e-6,-.009026,.001311,-.024059,.002217,-.019063,.002118,-.04849,659e-6,-.007014,529e-6,-.003632,157e-6,-265e-6,46e-6,-325e-6,503e-6],imag:[0,.20893,-1e-6,4e-6,-5e-6,3e-6,-4e-6,0,-6e-6,1e-6,-1e-5,1e-6,-4e-6,0,-1e-6,0,-3e-6,1e-6,-12e-6,1e-6,-11e-6,1e-6,-35e-6,1e-6,-6e-6,0,-4e-6,0,0,0,0,1e-6],mult:[.1,.1,.18,.016,.01,.01,.01,.004,.014,.02,.014,.004,.002,.01],freq:[35,60,100,135,180,240,420,800],defs:{wave:"string",gain:.6,attack:.001,decay:.95,sustain:.001,release:.1,decayfollow:.005,cutoff:2500,cutfollow:.1,resonance:.4,detune:.9994}},fiddle:{real:[0,.7,.4,.4,.45,.3,.1,.05,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],imag:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mult:[0,.9,.8,.7,.6,.5,.4,.3,.2,.1,0,0,0,0,0,0],freq:[35,60,100,135,180,240,420,800],defs:{wave:"string",gain:.8,attack:.12,decay:.05,sustain:.3,release:.1,decayfollow:.005,cutoff:2500,cutfollow:.1,resonance:.1,detune:.9994}},flute:{real:[0,.5,.5,.4,.4,.2,.1,.05,.02,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],imag:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mult:[0,.9,.8,.7,.6,.5,.4,.3,.2,0,0,0,0,0,0,0],freq:[35,60,100,135,180,240,420,800],defs:{wave:"string",gain:.6,attack:.14,decay:.066,sustain:.3,release:.05,decayfollow:.005,cutoff:1500,cutfollow:1e-4,resonance:.02,detune:.9994}},flute2:{real:[0,.3,.4,.3,.35,.2,.1,.05,.025,.0125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],imag:[0,.3,.4,.3,.35,.2,.1,.05,.025,.0125,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],mult:[0,.3,.4,.5,.5,.6,.5,.3,.2,.1,0,0,0,0,0,0],freq:[1,1,1,1,1,1,1,1],defs:{wave:"string",gain:.6,attack:.3,decay:.3,sustain:.3,release:.1,decayfollow:.005,cutoff:1e3,cutfollow:.5,resonance:.5,detune:.9994}}})}},{}]},{},[1])(1)}));